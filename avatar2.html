// Get username from local storage
let userName = localStorage.getItem('currentUser') || "TestUser";
document.getElementById('current-user').textContent = userName;

// Avatar state
const avatarState = {
  face: 'round',
  skinColor: '#FDE3D5',
  hair: 'short',
  hairColor: '#090806',
  eyes: 'round',
  eyeColor: '#634e34',
  mouth: 'smile',
  accessory: 'none'
};

// Initialize avatar preview
updateAvatarPreview();

// Load existing avatar if available
function loadExistingAvatar() {
  const savedAvatar = localStorage.getItem('userAvatar');
  if (savedAvatar) {
    try {
      const savedAvatarData = JSON.parse(savedAvatar);
      Object.assign(avatarState, savedAvatarData);
      updateUIFromState();
    } catch (e) {
      console.error("Error loading saved avatar:", e);
    }
  }
}

// Call this on page load
loadExistingAvatar();

// Tab switching functionality
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', function() {
    // Remove active class from all tabs
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    
    // Add active class to clicked tab
    this.classList.add('active');
    
    // Show corresponding tab content
    const tabId = this.getAttribute('data-tab');
    document.getElementById(tabId).classList.add('active');
  });
});

// Part selection functionality
document.querySelectorAll('.avatar-part').forEach(part => {
  part.addEventListener('click', function() {
    const type = this.getAttribute('data-type');
    const id = this.getAttribute('data-id');
    
    // Remove selected class from siblings
    document.querySelectorAll(`.avatar-part[data-type="${type}"]`).forEach(p => p.classList.remove('selected'));
    
    // Add selected class to this part
    this.classList.add('selected');
    
    // Update avatar state
    if (type === 'face') avatarState.face = id;
    else if (type === 'hair') avatarState.hair = id;
    else if (type === 'eyes') avatarState.eyes = id;
    else if (type === 'mouth') avatarState.mouth = id;
    else if (type === 'accessory') avatarState.accessory = id;
    
    updateAvatarPreview();
  });
});

// Color swatch selection functionality
document.querySelectorAll('.color-swatch').forEach(swatch => {
  swatch.addEventListener('click', function() {
    const color = this.getAttribute('data-color');
    
    // Find parent color picker
    const colorPicker = this.parentElement;
    
    // Remove selected class from siblings
    colorPicker.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
    
    // Add selected class to this swatch
    this.classList.add('selected');
    
    // Update avatar state based on parent color picker id
    if (colorPicker.id === 'skin-colors') avatarState.skinColor = color;
    else if (colorPicker.id === 'hair-colors') avatarState.hairColor = color;
    else if (colorPicker.id === 'eye-colors') avatarState.eyeColor = color;
    
    updateAvatarPreview();
  });
});

// Save avatar button click
document.getElementById('save-avatar').addEventListener('click', function() {
  // Save avatar state to local storage
  localStorage.setItem('userAvatar', JSON.stringify(avatarState));
  
  // Generate a simple avatar representation as SVG
  const avatarSVG = generateAvatarSVG();
  
  // Convert SVG to data URL for storage
  const svgBlob = new Blob([avatarSVG], {type: 'image/svg+xml'});
  const reader = new FileReader();
  reader.onload = function(e) {
    localStorage.setItem('userAvatarImage', e.target.result);
    showToast('Your avatar has been saved!', 'success');
  };
  reader.readAsDataURL(svgBlob);
});

// Random avatar button click
document.getElementById('random-avatar').addEventListener('click', function() {
  // Generate random avatar state
  const randomAvatar = {
    face: getRandomItem(['round', 'oval', 'square']),
    skinColor: getRandomItem(['#FDE3D5', '#F1C27D', '#E0AC69', '#C68642', '#8D5524', '#5C3518']),
    hair: getRandomItem(['short', 'medium', 'long', 'curly', 'bald']),
    hairColor: getRandomItem(['#090806', '#8D4A43', '#B55239', '#D6C4C2', '#DECBC6', '#F7F6F2']),
    eyes: getRandomItem(['round', 'almond', 'wide']),
    eyeColor: getRandomItem(['#634e34', '#2e536f', '#285c4d', '#3a3839', '#7c4b4b', '#8a5a83']),
    mouth: getRandomItem(['smile', 'neutral', 'laugh']),
    accessory: getRandomItem(['none', 'glasses', 'earrings', 'hat'])
  };
  
  // Update avatar state
  Object.assign(avatarState, randomAvatar);
  
  // Update UI to reflect new state
  updateUIFromState();
  
  // Update preview
  updateAvatarPreview();
  
  showToast('Created a random avatar!', 'success');
});

function getRandomItem(array) {
  return array[Math.floor(Math.random() * array.length)];
}

function updateUIFromState() {
  // Update face shape selection
  document.querySelectorAll(`.avatar-part[data-type="face"]`).forEach(part => {
    part.classList.toggle('selected', part.getAttribute('data-id') === avatarState.face);
  });
  
  // Update skin color selection
  document.querySelectorAll('#skin-colors .color-swatch').forEach(swatch => {
    swatch.classList.toggle('selected', swatch.getAttribute('data-color') === avatarState.skinColor);
  });
  
  // Update hair style selection
  document.querySelectorAll(`.avatar-part[data-type="hair"]`).forEach(part => {
    part.classList.toggle('selected', part.getAttribute('data-id') === avatarState.hair);
  });
  
  // Update hair color selection
  document.querySelectorAll('#hair-colors .color-swatch').forEach(swatch => {
    swatch.classList.toggle('selected', swatch.getAttribute('data-color') === avatarState.hairColor);
  });
  
  // Update eye shape selection
  document.querySelectorAll(`.avatar-part[data-type="eyes"]`).forEach(part => {
    part.classList.toggle('selected', part.getAttribute('data-id') === avatarState.eyes);
  });
  
  // Update eye color selection
  document.querySelectorAll('#eye-colors .color-swatch').forEach(swatch => {
    swatch.classList.toggle('selected', swatch.getAttribute('data-color') === avatarState.eyeColor);
  });
  
  // Update mouth style selection
  document.querySelectorAll(`.avatar-part[data-type="mouth"]`).forEach(part => {
    part.classList.toggle('selected', part.getAttribute('data-id') === avatarState.mouth);
  });
  
  // Update accessory selection
  document.querySelectorAll(`.avatar-part[data-type="accessory"]`).forEach(part => {
    part.classList.toggle('selected', part.getAttribute('data-id') === avatarState.accessory);
  });
}

function updateAvatarPreview() {
  // Create a simple SVG avatar
  const avatarSVG = generateAvatarSVG();
  
  // Insert the SVG into the preview container
  const avatarContainer = document.getElementById('avatar-preview');
  avatarContainer.innerHTML = avatarSVG;
}

function generateAvatarSVG() {
  // Generate SVG string for the avatar
  const svg = `
    <svg width="200" height="200" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
      <!-- Face shape -->
      ${getFaceShape()}
      
      <!-- Hair -->
      ${getHair()}
      
      <!-- Eyes -->
      ${getEyes()}
      
      <!-- Mouth -->
      ${getMouth()}
      
      <!-- Accessory -->
      ${getAccessory()}
    </svg>
  `;
  
  return svg;
}

function getFaceShape() {
  // Generate face shape based on current state
  const faceShape = avatarState.face;
  const skinColor = avatarState.skinColor;
  
  let path = '';
  
  switch (faceShape) {
    case 'round':
      path = `<circle cx="100" cy="100" r="70" fill="${skinColor}" />`;
      break;
    case 'oval':
      path = `<ellipse cx="100" cy="100" rx="60" ry="80" fill="${skinColor}" />`;
      break;
    case 'square':
      path = `<rect x="40" y="40" width="120" height="120" rx="20" fill="${skinColor}" />`;
      break;
    default:
      path = `<circle cx="100" cy="100" r="70" fill="${skinColor}" />`;
  }
  
  return path;
}

function getHair() {
  // Generate hair based on current state
  const hairStyle = avatarState.hair;
  const hairColor = avatarState.hairColor;
  
  let path = '';
  
  switch (hairStyle) {
    case 'bald':
      path = '';
      break;
    case 'short':
      path = `
        <path d="M40,70 C40,30 160,30 160,70" fill="${hairColor}" />
        <path d="M40,70 C40,50 45,40 30,20 L35,15 C50,30 60,40 100,40 C140,40 150,30 165,15 L170,20 C155,40 160,50 160,70" fill="${hairColor}" />
      `;
      break;
    case 'medium':
      path = `
        <path d="M40,70 C40,30 160,30 160,70" fill="${hairColor}" />
        <path d="M30,120 C20,80 30,60 30,20 L35,15 C50,30 60,40 100,40 C140,40 150,30 165,15 L170,20 C170,60 180,80 170,120" fill="${hairColor}" />
      `;
      break;
    case 'long':
      path = `
        <path d="M40,70 C40,30 160,30 160,70" fill="${hairColor}" />
        <path d="M20,170 C10,100 20,60 20,20 L25,15 C40,30 50,40 100,40 C150,40 160,30 175,15 L180,20 C180,60 190,100 180,170" fill="${hairColor}" />
      `;
      break;
    case 'curly':
      path = `
        <path d="M40,70 C40,30 160,30 160,70" fill="${hairColor}" />
        <path d="M30,150 C10,120 20,80 25,60 C15,50 30,30 40,40 C35,20 55,10 65,30 C75,10 95,20 85,40 C105,25 115,45 95,55 C115,65 105,85 85,80 C95,100 75,110 65,90 C55,110 35,100 40,80 C25,85 15,65 30,60 C20,80 10,120 30,150" fill="${hairColor}" />
        <path d="M170,150 C190,120 180,80 175,60 C185,50 170,30 160,40 C165,20 145,10 135,30 C125,10 105,20 115,40 C95,25 85,45 105,55 C85,65 95,85 115,80 C105,100 125,110 135,90 C145,110 165,100 160,80 C175,85 185,65 170,60 C180,80 190,120 170,150" fill="${hairColor}" />
      `;
      break;
    default:
      path = `<path d="M40,70 C40,30 160,30 160,70" fill="${hairColor}" />`;
  }
  
  return path;
}

function getEyes() {
  // Generate eyes based on current state
  const eyeShape = avatarState.eyes;
  const eyeColor = avatarState.eyeColor;
  
  let path = '';
  
  switch (eyeShape) {
    case 'round':
      path = `
        <circle cx="70" cy="85" r="10" fill="white" stroke="black" stroke-width="1" />
        <circle cx="130" cy="85" r="10" fill="white" stroke="black" stroke-width="1" />
        <circle cx="70" cy="85" r="5" fill="${eyeColor}" />
        <circle cx="130" cy="85" r="5" fill="${eyeColor}" />
      `;
      break;
    case 'almond':
      path = `
        <ellipse cx="70" cy="85" rx="12" ry="8" fill="white" stroke="black" stroke-width="1" />
        <ellipse cx="130" cy="85" rx="12" ry="8" fill="white" stroke="black" stroke-width="1" />
        <ellipse cx="70" cy="85" rx="6" ry="4" fill="${eyeColor}" />
        <ellipse cx="130" cy="85" rx="6" ry="4" fill="${eyeColor}" />
      `;
      break;
    case 'wide':
      path = `
        <ellipse cx="70" cy="85" rx="15" ry="10" fill="white" stroke="black" stroke-width="1" />
        <ellipse cx="130" cy="85" rx="15" ry="10" fill="white" stroke="black" stroke-width="1" />
        <ellipse cx="70" cy="85" rx="7" ry="5" fill="${eyeColor}" />
        <ellipse cx="130" cy="85" rx="7" ry="5" fill="${eyeColor}" />
      `;
      break;
    default:
      path = `
        <circle cx="70" cy="85" r="10" fill="white" stroke="black" stroke-width="1" />
        <circle cx="130" cy="85" r="10" fill="white" stroke="black" stroke-width="1" />
        <circle cx="70" cy="85" r="5" fill="${eyeColor}" />
        <circle cx="130" cy="85" r="5" fill="${eyeColor}" />
      `;
  }
  
  return path;
}

function getMouth() {
  // Generate mouth based on current state
  const mouthStyle = avatarState.mouth;
  
  let path = '';
  
  switch (mouthStyle) {
    case 'smile':
      path = `
        <path d="M70,120 Q100,150 130,120" fill="none" stroke="black" stroke-width="3" />
      `;
      break;
    case 'neutral':
      path = `
        <line x1="70" y1="125" x2="130" y2="125" stroke="black" stroke-width="3" />
      `;
      break;
    case 'laugh':
      path = `
        <path d="M70,120 Q100,160 130,120" fill="none" stroke="black" stroke-width="3" />
        <path d="M70,120 Q100,140 130,120" fill="#FF9999" />
      `;
      break;
    default:
      path = `
        <path d="M70,120 Q100,140 130,120" fill="none" stroke="black" stroke-width="3" />
      `;
  }
  
  return path;
}

function getAccessory() {
  // Generate accessory based on current state
  const accessoryType = avatarState.accessory;
  
  let path = '';
  
  switch (accessoryType) {
    case 'none':
      path = '';
      break;
    case 'glasses':
      path = `
        <circle cx="70" cy="85" r="15" fill="none" stroke="black" stroke-width="2" />
        <circle cx="130" cy="85" r="15" fill="none" stroke="black" stroke-width="2" />
        <line x1="85" y1="85" x2="115" y2="85" stroke="black" stroke-width="2" />
        <line x1="55" y1="85" x2="45" y2="80" stroke="black" stroke-width="2" />
        <line x1="145" y1="85" x2="155" y2="80" stroke="black" stroke-width="2" />
      `;
      break;
    case 'earrings':
      path = `
        <circle cx="35" cy="100" r="5" fill="gold" />
        <circle cx="165" cy="100" r="5" fill="gold" />
      `;
      break;
    case 'hat':
      path = `
        <path d="M40,70 C40,30 160,30 160,70" fill="#555555" />
        <ellipse cx="100" cy="30" rx="70" ry="20" fill="#555555" />
      `;
      break;
    default:
      path = '';
  }
  
  return path;
}

function showToast(message, type = 'success') {
  // Remove any existing toasts
  const existingToast = document.querySelector('.toast');
  if (existingToast) {
    existingToast.remove();
  }
  
  // Create new toast
  const toast = document.createElement('div');
  toast.className = `toast ${type}-toast fade-in`;
  toast.textContent = message;
  document.body.appendChild(toast);
  
  // Remove toast after 3 seconds
  setTimeout(() => {
    toast.classList.remove('fade-in');
    toast.classList.add('fade-out');
    setTimeout(() => toast.remove(), 500);
  }, 3000);
}
